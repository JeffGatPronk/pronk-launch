<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pronk → TMS Upload</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { font-weight: bold; }
    #status { margin-top: 10px; color: green; }
    #warning { margin-top: 10px; color: #b45309; }
    pre { background: #f3f4f6; padding: 10px; border-radius: 5px; }
  </style>

  <script>
    // Capture TMS query parameters
    const params = new URLSearchParams(window.location.search);
    const TMS_PARAMS = {};
    for (const [key, value] of params.entries()) {
      TMS_PARAMS[key] = decodeURIComponent(value);
    }
    console.log("Captured TMS parameters:", TMS_PARAMS);
  </script>
</head>

<body>

<h2>Pronk PDF Upload → TMS Procedure Readings</h2>
<p>Select the PDF report generated by Pronk Mobilize for this procedure. After submission, the browser will navigate to TMS FileExchange.</p>

<form id="uploadForm"
      action="https://fhbio.stage.tmsonline.com/tms/tmsconnect/fileexchange"
      method="POST"
      enctype="multipart/form-data">

  <!-- Hidden fields -->
  <input type="hidden" name="WorkOrderID" id="wo">
  <input type="hidden" name="ProcedureInstanceID" id="pi">
  <input type="hidden" name="AssetID" id="asset">

  <input type="hidden" name="DocumentType" value="ProcedureReadings">
  <input type="hidden" name="Description" value="Pronk Mobilize PDF Upload">
  <input type="hidden" name="Overwrite" value="false">

  <label for="fileInput">Select PDF:</label><br><br>
  <input type="file" name="File" id="fileInput" accept=".pdf" required><br><br>

  <button type="submit">Upload PDF to TMS</button>
</form>

<div id="status"></div>
<div id="warning"></div>
<pre id="debug"></pre>

<script>
  const woField = document.getElementById("wo");
  const piField = document.getElementById("pi");
  const assetField = document.getElementById("asset");

  woField.value = TMS_PARAMS["workOrderID"] || "";
  piField.value = TMS_PARAMS["procedureID"] || "";
  assetField.value = TMS_PARAMS["asset"] || TMS_PARAMS["assetAlt"] || "";

  document.getElementById("debug").textContent =
    JSON.stringify({
      WorkOrderID: woField.value,
      ProcedureInstanceID: piField.value,
      AssetID: assetField.value
    }, null, 2);

  // Warn if ProcedureInstanceID is empty
  document.getElementById("uploadForm").addEventListener("submit", () => {
    if (!piField.value) {
      document.getElementById("warning").textContent =
        "Warning: ProcedureInstanceID is empty. PDF will attach to Work Order only.";
    }
  });
</script>

</body>
</html>
