<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pronk → TMS Upload</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { font-weight: bold; }
    #status { margin-top: 10px; color: green; }
    #warning { margin-top: 10px; color: #b45309; }
    pre { background: #f3f4f6; padding: 10px; border-radius: 5px; }
  </style>

  <script>
    // Parse TMS query parameters, handling spaces in names
    const params = new URLSearchParams(window.location.search);
    const TMS_PARAMS = {};
    for (const [key, value] of params.entries()) {
      TMS_PARAMS[decodeURIComponent(key)] = decodeURIComponent(value);
    }
    console.log("Captured TMS parameters:", TMS_PARAMS);
    window.TMS_PARAMS = TMS_PARAMS;
  </script>
</head>

<body>

<h2>Pronk PDF Upload → TMS Procedure Readings</h2>
<p>Select the PDF report generated by Pronk Mobilize for this procedure.</p>

<form id="uploadForm" target="hiddenFrame"
      action="https://fhbio.stage.tmsonline.com/tms/tmsconnect/fileexchange"
      method="POST"
      enctype="multipart/form-data">

  <!-- Hidden fields -->
  <input type="hidden" name="WorkOrderID" id="wo">
  <input type="hidden" name="ProcedureInstanceID" id="pi">
  <input type="hidden" name="AssetID" id="asset">

  <input type="hidden" name="DocumentType" value="ProcedureReadings">
  <input type="hidden" name="Description" value="Pronk Mobilize PDF Upload">
  <input type="hidden" name="Overwrite" value="false">

  <label for="fileInput">Select PDF:</label><br><br>
  <input type="file" name="File" id="fileInput" accept=".pdf" required>
</form>

<iframe name="hiddenFrame" style="display:none;"></iframe>

<div id="status"></div>
<div id="warning"></div>
<pre id="debug"></pre>

<script>
  // Populate hidden fields from TMS parameters
  const woField = document.getElementById("wo");
  const piField = document.getElementById("pi");
  const assetField = document.getElementById("asset");

  woField.value = TMS_PARAMS["Work Order ID"] || "";
  piField.value = TMS_PARAMS["Procedure ID for OneQA"] || TMS_PARAMS["Procedure Number"] || "";
  assetField.value = TMS_PARAMS["Asset"] || TMS_PARAMS["Asset ID"] || "";

  // Display captured parameters for debugging
  document.getElementById("debug").textContent =
    JSON.stringify({
      WorkOrderID: woField.value,
      ProcedureInstanceID: piField.value,
      AssetID: assetField.value
    }, null, 2);

  const form = document.getElementById("uploadForm");
  const fileInput = document.getElementById("fileInput");
  const status = document.getElementById("status");
  const warning = document.getElementById("warning");

  fileInput.addEventListener("change", () => {
    if (!fileInput.files.length) return;

    status.textContent = `Uploading PDF for WorkOrderID=${woField.value} ...`;
    warning.textContent = "";
    form.submit();

    setTimeout(() => {
      if (!piField.value) {
        warning.textContent = "Note: ProcedureInstanceID is empty. PDF will attach to Work Order only.";
      }
      status.textContent =
        `Upload complete. Check TMS for WorkOrderID=${woField.value} Procedure Readings.`;
    }, 3000);
  });
</script>

</body>
</html>
