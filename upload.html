<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pronk → TMS Upload (Edge Optimized)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { font-weight: bold; }
    #status { margin-top: 10px; color: green; }
    #warning { margin-top: 10px; color: #b45309; }
    pre { background: #f3f4f6; padding: 10px; border-radius: 5px; }
  </style>
  <script>
    // Capture query parameters from TMS External Link
    const params = new URLSearchParams(window.location.search);
    const TMS_PARAMS = {};
    for (const [key, value] of params.entries()) {
      TMS_PARAMS[key] = decodeURIComponent(value);
    }
    console.log("Captured TMS parameters:", TMS_PARAMS);
  </script>
</head>
<body>

<h2>Pronk PDF Upload → TMS Procedure Readings (Edge Optimized)</h2>
<p>The PDF will automatically upload to TMS. If ProcedureInstanceID is missing, it will attach to the Work Order only.</p>

<form id="uploadForm"
      action="https://fhbio.stage.tmsonline.com/tms/tmsconnect/fileexchange"
      method="POST"
      enctype="multipart/form-data">

  <!-- Hidden fields populated from TMS parameters -->
  <input type="hidden" name="WorkOrderID" id="wo">
  <input type="hidden" name="ProcedureInstanceID" id="pi">
  <input type="hidden" name="AssetID" id="asset">

  <input type="hidden" name="DocumentType" value="ProcedureReadings">
  <input type="hidden" name="Description" value="Pronk Mobilize PDF Upload">
  <input type="hidden" name="Overwrite" value="false">

  <label for="fileInput">Select PDF:</label><br><br>
  <input type="file" name="File" id="fileInput" accept=".pdf" required>
</form>

<div id="status"></div>
<div id="warning"></div>
<pre id="debug"></pre>

<script>
  const woField = document.getElementById("wo");
  const piField = document.getElementById("pi");
  const assetField = document.getElementById("asset");
  const status = document.getElementById("status");
  const warning = document.getElementById("warning");
  const debug = document.getElementById("debug");

  // Pre-fill hidden fields from TMS parameters
  woField.value = TMS_PARAMS["workOrderID"] || "";
  piField.value = TMS_PARAMS["procedureID"] || "";
  assetField.value = TMS_PARAMS["asset"] || TMS_PARAMS["assetAlt"] || "";

  debug.textContent = JSON.stringify({
    WorkOrderID: woField.value,
    ProcedureInstanceID: piField.value,
    AssetID: assetField.value
  }, null, 2);

  const form = document.getElementById("uploadForm");
  const fileInput = document.getElementById("fileInput");

  // Auto-submit once a PDF is selected
  fileInput.addEventListener("change", () => {
    if (!fileInput.files.length) return;

    // Warn if ProcedureInstanceID is empty
    if (!piField.value) {
      warning.textContent = "Warning: ProcedureInstanceID is empty. PDF will attach to Work Order only.";
    } else {
      warning.textContent = "";
    }

    status.textContent = `Uploading PDF for WorkOrderID=${woField.value}...`;
    
    // Submit form directly to TMS
    form.submit();

    // Optional: Show a brief status before navigation
    setTimeout(() => {
      status.textContent = "Upload submitted. The page will now navigate to TMS FileExchange.";
    }, 500);
  });

  // Optional: automatically focus file input for faster workflow
  fileInput.focus();
</script>

</body>
</html>
