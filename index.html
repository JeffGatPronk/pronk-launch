<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pronk Mobilize Launcher</title>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 60px;
    }

    #launchButton {
      padding: 20px 40px;
      font-size: 18px;
      background-color: #0078D7;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #launchButton:hover {
      background-color: #005a9e;
    }

    #status {
      margin-top: 20px;
      font-size: 14px;
      color: #555;
    }
  </style>

  <script>
    console.log("FULL URL:", window.location.href);
    console.log("RAW QUERY:", window.location.search);

    function getParam(name) {
      const q = window.location.search.substring(1);
      const pairs = q.split('&');

      for (const pair of pairs) {
        const [key, ...rest] = pair.split('=');
        if (decodeURIComponent(key).trim() === name) {
          return decodeURIComponent(rest.join('=')).trim();
        }
      }
      return null;
    }

    const asset =
      getParam("Asset ID") ||
      getParam("AssetID") ||
      getParam("assetid") ||
      getParam("asset_number");

    const workOrder =
      getParam("Work Order") ||
      getParam("WorkOrder") ||
      getParam("WorkOrderNumber") ||
      getParam("wo");

    console.log("---- TMS PARAMETERS ----");
    console.log("Asset =", asset);
    console.log("WorkOrder =", workOrder);

    window.TMS_PARAMS = {
      asset: asset,
      workOrder: workOrder
    };

    const autotest = '{"NFPA992012APwGND","2sec,Rpt,PwrEnd,A","GndRes,500","NP:CL:NC,100","NP:CL:OG,500","NP:LLG:NC,100","NP:LLG:OG,500"}';

    let pronkUrl = null;

    function buildPronkUrl() {
      if (!asset || !workOrder) {
        document.getElementById("status").innerText =
          "Missing Asset or Work Order from TMS. Cannot launch.";
        console.error("Missing required parameters.");
        return null;
      }

      return `pronk://devtype?asset=${encodeURIComponent(asset)}&wo=${encodeURIComponent(workOrder)}&output=json&autotest=${encodeURIComponent(autotest)}`;
    }

    function launchPronk() {
      if (!pronkUrl) {
        pronkUrl = buildPronkUrl();
      }

      if (!pronkUrl) return;

      console.log("Launching:", pronkUrl);

      try {
        window.location.href = pronkUrl;
      } catch (e) {
        console.error("Launch failed:", e);
      }
    }

    window.onload = function() {
      pronkUrl = buildPronkUrl();

      if (pronkUrl) {
        document.getElementById("status").innerText =
          "Launching Pronk Mobilize...";
        setTimeout(launchPronk, 500);
      }
    };
  </script>
</head>

<body>
  <h2>Pronk Mobilize Launcher</h2>

  <p>If the test does not launch automatically, click below:</p>

  <button id="launchButton" onclick="launchPronk()">
    Launch Pronk Mobilize
  </button>

  <div id="status"></div>
</body>
</html>
