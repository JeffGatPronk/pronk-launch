<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pronk Mobilize Launcher</title>
  <style>
    body { 
      font-family: sans-serif; 
      text-align: center; 
      margin-top: 50px; 
    }
    #status { 
      font-size: 18px; 
      color: #0078D7; 
    }
  </style>
</head>
<body>
  <h2>Launching Pronk Mobilize...</h2>
  <p id="status">Initializing...</p>

  <script>
    // --- Helper: Get query parameters (supports spaces in names) ---
    function getParam(name) {
      const q = window.location.search.substring(1);
      const pairs = q.split('&');
      for (const pair of pairs) {
        const [key, ...rest] = pair.split('=');
        if (decodeURIComponent(key).trim() === name) {
          return decodeURIComponent(rest.join('=')).trim();
        }
      }
      return null;
    }

    // --- Capture TMS parameters ---
    const WORKORDER_NUMBER = getParam("WO Number") || "";
    const ASSET_NUMBER = getParam("Asset ID") || "";

    console.log("Captured parameters:");
    console.log("WorkOrder:", WORKORDER_NUMBER);
    console.log("Asset:", ASSET_NUMBER);

    const status = document.getElementById("status");

    if (!WORKORDER_NUMBER || !ASSET_NUMBER) {
      alert("Missing Asset or Work Order from TMS. Cannot launch.");
      status.innerText = "Missing parameters. Launch aborted.";
      throw new Error("Missing required parameters");
    }

    status.innerText = "Starting Pronk Mobilize...";

    // --- Autotest JSON (your working format) ---
    const autotest = '{"NFPA992012NOGND","2sec,Rpt,PwrEnd,A","NP:CL:NC,100","NP:CL:OG,500"}';

    // --- Build Pronk URL ---
    const pronkUrl = `pronk://devtype?asset=${encodeURIComponent(ASSET_NUMBER)}&workOrder=${encodeURIComponent(WORKORDER_NUMBER)}&output=json&callback=pronkexe://result/&autotest=${encodeURIComponent(autotest)}`;

    console.log("Launching:", pronkUrl);

    function launchMobilize() {
      // Launch Mobilize via hidden iframe
      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = pronkUrl;
      document.body.appendChild(iframe);

      // Remove iframe quickly
      setTimeout(() => {
        document.body.removeChild(iframe);
      }, 500);

      // Close launcher window so next test can start
      setTimeout(() => {
        window.open('', '_self');
        window.close();
        window.location.replace("about:blank"); // fallback
      }, 800);
    }

    // --- Auto launch immediately ---
    window.onload = launchMobilize;

  </script>
</body>
</html>
</body>
</html>
