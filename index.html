<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

  <!-- Prevent browser caching -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Pronk Mobilize Launcher</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 60px;
    }
  </style>
</head>
<body>

  <h2>Launching Mobilize Test...</h2>
  <p id="status">Preparing test...</p>

  <script>
    // ------------------------------------------
    // Helper: Get Query Parameter From TMS
    // ------------------------------------------
    function getParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // ------------------------------------------
    // Get Values Passed From TMS
    // ------------------------------------------
    const WORKORDER_NUMBER = getParam("WO Number");
    const ASSET_NUMBER = getParam("Asset ID");

    if (!WORKORDER_NUMBER || !ASSET_NUMBER) {
      document.getElementById("status").innerText =
        "Missing Work Order or Asset from TMS.";
      throw new Error("Missing required parameters from TMS");
    }

    // ------------------------------------------
    // Autotest Definition (your required format)
    // ------------------------------------------
    const autotest = '{"NFPA992012NOGND","2sec,Rpt,PwrEnd,A","NP:CL:NC,100","NP:CL:OG,500"}';

    // ------------------------------------------
    // Build Callback WITH Parameters
    // ------------------------------------------
    const rawCallback =
      `Openerapp://result/?wo=${encodeURIComponent(WORKORDER_NUMBER)}` +
      `&asset=${encodeURIComponent(ASSET_NUMBER)}`;

    const encodedCallback = encodeURIComponent(rawCallback);

    // ------------------------------------------
    // Build Final Pronk URL
    // ------------------------------------------
    const pronkUrl =
      `pronk://devtype?asset=${encodeURIComponent(ASSET_NUMBER)}` +
      `&workOrder=${encodeURIComponent(WORKORDER_NUMBER)}` +
      `&callback=${encodedCallback}` +
      `&autotest=${encodeURIComponent(autotest)}` +
      `&t=${Date.now()}`;

    // ------------------------------------------
    // Launch Mobilize
    // ------------------------------------------
    function launchMobilize() {
      document.getElementById("status").innerText =
        "Opening Mobilize...";

      // Direct protocol navigation (most reliable)
      window.location.href = pronkUrl;

      // Auto close launcher window
      setTimeout(() => {
        window.open('', '_self');
        window.close();
      }, 800);
    }

    // Launch automatically when page loads
    window.onload = launchMobilize;

  </script>

</body>
</html>
