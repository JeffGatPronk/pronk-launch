<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

  <!-- ðŸ”¥ Prevent ALL caching -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Pronk Mobilize Launcher</title>

  <script>
    // Force reload from server if somehow cached
    if (performance.navigation.type === 1) {
      location.reload(true);
    }
  </script>

  <style>
    body { 
      font-family: sans-serif; 
      text-align: center; 
      margin-top: 50px; 
    }
  </style>
</head>
<body>
  <h2>Launching Pronk Mobilize...</h2>

  <script>
    // --- Prevent browser caching this page entirely ---
    window.onpageshow = function(event) {
      if (event.persisted) {
        window.location.reload();
      }
    };

    // --- Helper to read TMS parameters ---
    function getParam(name) {
      const q = window.location.search.substring(1);
      const pairs = q.split('&');
      for (const pair of pairs) {
        const [key, ...rest] = pair.split('=');
        if (decodeURIComponent(key).trim() === name) {
          return decodeURIComponent(rest.join('=')).trim();
        }
      }
      return null;
    }

    const WORKORDER_NUMBER = getParam("WO Number") || "";
    const ASSET_NUMBER = getParam("Asset ID") || "";

    if (!WORKORDER_NUMBER || !ASSET_NUMBER) {
      alert("Missing Asset or Work Order from TMS.");
      throw new Error("Missing required parameters");
    }

    const autotest = '{"NFPA992012NOGND","2sec,Rpt,PwrEnd,A","NP:CL:NC,100","NP:CL:OG,500"}';

    // Add timestamp to bust cache every time
    const cacheBuster = Date.now();

    const pronkUrl =
      `pronk://devtype?asset=${encodeURIComponent(ASSET_NUMBER)}` +
      `&workOrder=${encodeURIComponent(WORKORDER_NUMBER)}` +
      `&output=json` +
      `&callback=pronkexe://result/` +
      `&autotest=${encodeURIComponent(autotest)}` +
      `&t=${cacheBuster}`;

    function launchMobilize() {

      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = pronkUrl;
      document.body.appendChild(iframe);

      setTimeout(() => {
        document.body.removeChild(iframe);
      }, 400);

      // Close immediately so next test can start
      setTimeout(() => {
        window.open('', '_self');
        window.close();
        window.location.replace("about:blank");
      }, 700);
    }

    window.onload = launchMobilize;
  </script>
</body>
</html>
