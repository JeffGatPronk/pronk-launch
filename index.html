<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pronk Mobilize</title>
  <script>
    // Capture all TMS parameters dynamically
    const params = new URLSearchParams(window.location.search);

    // Get asset from TMS (required)
    const asset = params.get("asset") || "t1234"; // fallback if missing

    // Build other TMS fields dynamically (optional)
    const passthrough = [];
    for (const [key, value] of params.entries()) {
      if (key.toLowerCase() !== "asset" && key.toLowerCase() !== "autotest") {
        passthrough.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
      }
    }

    // Fixed autotest block
    const autotestBlock =
      '{"NFPA992012APwGND","2sec,Rpt,PwrEnd,A","GndRes,500","NP:CL:NC,100","NP:CL:OG,500","NP:LLG:NC,100","NP:LLG:OG,500"}';

    // Build final Pronk deep link
    let pronkUrl = `pronk://devtype?asset=${encodeURIComponent(asset)}&output=json&autotest=${autotestBlock}`;
    if (passthrough.length > 0) {
      pronkUrl += "&" + passthrough.join("&");
    }

    // Function to launch Pronk Mobilize in a new tab
    function launchMobilize() {
      const newWindow = window.open(pronkUrl, '_blank');
      if (!newWindow) {
        // Fallback: show manual link if popup blocked
        const fallback = document.getElementById('manualLaunch');
        fallback.style.display = "inline";
      } else {
        // Auto-close this redirect tab
        setTimeout(() => window.close(), 600);
      }
    }

    // Hidden button fallback to simulate user gesture
    function launchWithClickFallback() {
      const btn = document.createElement('button');
      btn.style.display = "none";
      document.body.appendChild(btn);
      btn.addEventListener('click', launchMobilize);
      btn.click(); // Trigger programmatic click
    }

    // Launch on page load
    window.onload = function() {
      launchWithClickFallback();
    };
  </script>
</head>
<body>
  <p style="font-family: sans-serif;">Launching Pronk Mobilizeâ€¦</p>
  <p style="font-family: sans-serif; display:none;" id="manualLaunch">
    Click <a id="manualLink" href="">here</a> if Pronk Mobilize does not launch automatically.
  </p>
  <script>
    // Assign fallback link dynamically
    document.getElementById('manualLink').href = pronkUrl;
  </script>
</body>
</html>
